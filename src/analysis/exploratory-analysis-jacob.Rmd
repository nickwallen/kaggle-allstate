Kaggle Allstate Purchase Prediction Competition
========================================================

Of course, start out by loading the source data sets.

```{r fetch.data,message=FALSE}
library(randomForest)
library(caret)
library(data.table)
library(e1071)
source ("../R/fetch.R")
source ("../R/utils.R")
source ("../R/features.R")
source ("../R/score.R")
train <- fetch()
add.plan(train)
```


Frequency of Each Plan Variation

``` {r count.plans}

#train[, plan := paste0(option.a,option.b,option.c,option.d,option.e,option.f,option.g)]
ct.prod <- train[, list(ct = length(customer.id)),by=plan]
ggplot(ct.prod,aes(ct))+geom_histogram()

ggplot(ct.prod,aes(ct))+stat_ecdf()


```

Build Model Based only on Customer Attributes & Purchase Points
========================================================================

```{r cust.model,message=FALSE}
buy <- train[record.type == "purchase"]


# create a train and test set
train.index <- createDataPartition(y= buy$plan, p=.80,list=FALSE)[,1]
cust.train <- buy[train.index]
cust.test  <- buy[-train.index]

# defines how the parameter tuning will occur
control <- trainControl (method = "cv", number = 2)

# which model parameters will be tuned?
tune.grid <- expand.grid (
  mtry      = c(4,6))

models <- lapply(options(), function(option) {
  train(
    method    = "rf",
    trControl = control,
    y         = cust.train[[option]],
    x         = cust.train[,c(2,4,6,9:18,26), with = FALSE], 
    tuneGrid  = tune.grid,
    sampsize  = 5000,
    ntree     = 200)
})
```

Make predictions with the various models
```{r}
names(models) <- options.hat()

for (option.hat in names(models)) {

    # make a prediction for each option
    model <- models[[option.hat]]
    cust.test[, `:=`(option.hat, predict(model, .SD)), .SDcols = c(2,4,6,9:18,26), with = FALSE]
}

```

How accurate are the predictions?
```{r}
# score the results
accuracy.score(cust.test)

```
